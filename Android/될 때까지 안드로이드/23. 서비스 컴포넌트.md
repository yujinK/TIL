## 23. 서비스 컴포넌트

> "서비스는 백그라운드에서 어떤 기능을 수행하는 컴포넌트다"



### 23.1 서비스가 필요한 이유

- 다른 컴포넌트에게 서비스를 제공
- 앱을 종료해도 계속해서 수행되어야 할 때 사용
- 스레드를 이용하면 앱을 종료하기 전에 시작한 스레드를 중지할 수 있지만, 앱을 종료한 이후에는 이미 시작된 스레드를 종료할 수 있는 방법이 없음 -> 서비스 컴포넌트로 문제 해결



### 23.2 서비스 사용하기

- 스타트 서비스(Start Service)
  - 시작해두면 완전히 <u>독립적</u>으로 수행되는 작업
  - 다른 컴포넌트가 중간에 종료시킬 수 있음
- 바인드 서비스(Bind Service)
  - 서비스와 다른 컴포넌트와 연결고리를 만듦
  - 연결된 컴포넌트의 상태에 따라 서비스의 동작을 제어할 수 있음
  - 다른 컴포넌트에 <u>의존</u>
- 스타트 / 바인드 중 선택하여 사용할 수도 있고, 둘 다 사용할수도 있음 (목적에 맞게 사용)



#### 23.2.1 스타트 서비스

- 파일 다운로드, 음악 재생과 같은 기능 구현 시
- 서비스를 가리키는 인텐트 전달
- 서비스 시작
  - startService()
  - Service에서 onStartCommand() 메서드 오버라이드
- 서비스 중지
  - stopService()
  - Service에서 onDestroy() 메서드 오버라이드
- 서비스는 액티비티와 독립적으로 동작하므로 서비스의 생명주기에 영향 X
- cf.) 사용자가 앱을 사용 중일 때만 동작해야 하는 상황에서는 **스레드 사용**
- 서비스가 수행하는 작업이 메인 스레드를 점유하는 일이라면 UI를 차단하지 않도록 서비스 내에서 스레드 생성해야 함



- 서비스의 생존을 결정하는 방법
  - 안드로이드 시스템은 자원이 부족하면 백그라운드에서 실행되는 프로세스를 강제 종료함
  - 강제 종료된 서비스를 살릴 수 있는 옵션 (onStartCommand() 메서드의 반환값)
    - START_NOT_STICKY
    - START_STICKY
    - START_REDELIVER_INTENT

- 서비스에서 스레드를 사용하는 이유
  - 안드로이드 4대 컴포넌트는 메인 스레드(UI 스레드)에서 실행되므로 오래 걸리는 처리를 하게 되면 화면이 버벅대면서 ANR이 발생
  - ANR 발생을 막으려면 서비스 내에서 스레드 생성
- 서비스의 종료
  - 컴포넌트에서 stopService() 메서드 사용
  - 서비스 내에서 stopSelf() 메서드 사용



#### 23.2.2 인텐트 서비스

- 대부분 서비스는 여러 요청을 동시에 처리하지 않아도 됨

- onStartCommand() 메서드에 전달된 인텐트마다 별도의 스레드를 자동 생성

- <u>한 번에 하나의 인텐트를 처리</u>하는 **onHandleIntent()** 메서드 제공

- 모든 수행이 끝나면 자동으로 stopSelf() 메서드 호출하고 종료

- <u>작업 스레드</u>에서 동작 -> 일반 서비스보다 코드 간결
- 인텐트 서비스는 순서대로 일을 처리하고 스스로 stopSelf() 메서드를 호출하므로 도중에 stopService() 메서드를 호출하지 않아도 됨



#### 23.2.3 죽지 않는 서비스

- 포그라운드(foreground) 서비스는 메모리가 부족할 때도 안드로이드 시스템이 강제로 종료할 수 없고, 서비스를 중단하거나 알림에서 제거되어야만 종료시킬 수 있음
- 포그라운드 서비스를 만들 때 지켜야 할 점
  - 상태 표시줄에 표시되는 알림(Notification)을 제공해야 함
  - 알림의 id가 0이 아니어야 함
  - 서비스 내부에서 startForeground() 메서드를 호출하여 포그라운드 서비스를 시작함
- 포그라운드 서비스 종료
  - stopForeground()
  - 매서드가 서비스를 종료시키는 게 아닌, 서비스가 시스템에 의해 강제 종료 대상이 되는 것



### 23.3 바인드 서비스

- 서비스와 다른 구성요소를 서로 연결하려면 다른 구성요소가 서비스에 바인드(bind) 해야 함



#### 23.3.1 바인드 서비스 작성

- 서비스끼리 데이터를 주고받으려면 바인더(binder) 사용
- Service 클래스 onBind() 메서드에서 바인더 객체 반환



#### 23.3.2 ServiceConnection 객체 정의

- 컴포넌트를 서비스에 연결하기 위해 필요
- 두 가지 콜백 메서드 제공
  - 서비스에 연결되었는지 알 수 있는 콜백
  - 서비스가 시스템에 의해 강제로 종료되었을 때 상태를 감지할 수 있는 콜백
- onStart() 메서드에서 bindService() 메서드로 서비스에 연결
- onPause() 메서드에서 unBindService() 메서드로 연결 해제



#### 23.3.3 바인딩 상태 확인

- onCreate()
- onBind()
- onUnbind()
- onDestroy()



#### 23.3.4 바인드 서비스의 기능 사용

- 바운드 서비스가 바인드 중일 때는 바인드 해제될 때까지 stopService()로 서비스 종료 불가능, startService()는 가능



### 23.4 서비스의 생명주기

- 스타트 서비스
  - onCreate()
  - onStartCommand()
  - onDestroy()
- 바인드 서비스
  - onCreate()
  - onBind()
  - 해제되면 onUnbind()
  - onDestroy()
- 두 서비스가 동작하는 시기 : onCreate() ~ onDestroy()
- 바인드 서비스는 바인딩이 해제되면 안드로이드 시스템이 서비스를 종료
- 스타스 서비스는 바인딩 여부와 상관없이, 개발자가 생명주기 관리